<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Gold Rush Statistics</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 2px;
            font-size: small;
        }

        th {
            background-color: #f4f4f4;
        }

        input {
            width: 100%;
            padding: 4px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <h1>Gold Rush</h1>
    <div>
        <pre>

     5 6 7
  4  ♣ B ♥  8
3 ♦  7 8 9  ♠
2 R  6 1 2  R
1 ♥  5 4 3  ♣
     ♠ B ♦

A = sum of matches is under 49
B = sum of matches is 49
C = sum of matches is over 49

&lt;num&gt; = number of matching lines

Z = one of the matching lines is three aces
X = one of the matching lines is three of a kind

e.g
  C8X means that the sum of matches is over 49, there are 8 matching lines,
  and at least one of the lines has three of a kind but not three aces.
        </pre>
    </div>
    <p class="rtp">RTP: 0.0</p>
    <hr>

    <div>
        <button style="padding-right: 5px" id="copy">Click to copy to clipboard</button>
        <button id="paste">Click to paste from clipboard</button>
        <span>
            <span style="background-color: red;">red</span> means that the table is not updated
        </span>
        <button id="update">Click to update</button>
        <span> or press enter on an input</span>
    </div>
    <hr>
    <table>
        <thead>
            <tr>
                <th id="th-id">Hand</th>
                <th id="th-sats">Payout Ratio</th>
                <th id="th-count">Count</th>
                <th id="th-probability">Probability (%)</th>
                <th id="th-payout">Payout</th>
                <th id="th-payoutProbability">Payout Probability (%)</th>
            </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
    <p class="rtp">RTP: 0.0</p>
    <hr>
    <div>
        <div><button id="reset">reset to default values</button></div>
        <hr>
    </div>
</body>


<script>

    const cache_key = '2025-08-20';  // update to invalidate localstorage
    let hands = [];
    let default_hands = [
        { id: 1, hand: "A0", sats: 0, count: 27962599 },
        { id: 2, hand: "A1", sats: 0, count: 27747082 },
        { id: 3, hand: "A2", sats: 0.5, count: 12171298 },
        { id: 4, hand: "A3", sats: 1, count: 4263921 },
        { id: 5, hand: "A4", sats: 2, count: 1018897 },
        { id: 6, hand: "A5", sats: 5, count: 245967 },
        { id: 7, hand: "A6", sats: 10, count: 90455 },
        { id: 8, hand: "A6X", sats: 10, count: 2455 },
        { id: 9, hand: "A6Z", sats: 10, count: 0 },
        // { id: 10, hand: "A7", sats: 0, count: 0 },
        // { id: 11, hand: "A7X", sats: 0, count: 0 },
        // { id: 12, hand: "A7Z", sats: 0, count: 0 },
        { id: 13, hand: "A8", sats: 100, count: 4652 },
        { id: 14, hand: "A8X", sats: 100, count: 268 },
        { id: 15, hand: "A8Z", sats: 100, count: 0 },
        { id: 16, hand: "B0", sats: 1, count: 143763 },
        { id: 17, hand: "B1", sats: 2, count: 656076 },
        { id: 18, hand: "B2", sats: 4, count: 739932 },
        { id: 19, hand: "B3", sats: 8, count: 432340 },
        { id: 20, hand: "B4", sats: 16, count: 149655 },
        { id: 21, hand: "B5", sats: 32, count: 43180 },
        { id: 22, hand: "B6", sats: 64, count: 19915 },
        { id: 23, hand: "B6X", sats: 64, count: 332 },
        { id: 24, hand: "B6Z", sats: 64, count: 0 },
        // { id: 25, hand: "B7", sats: 0, count: 0 },
        // { id: 26, hand: "B7X", sats: 0, count: 0 },
        // { id: 27, hand: "B7Z", sats: 0, count: 0 },
        { id: 28, hand: "B8", sats: 100, count: 1410 },
        { id: 29, hand: "B8X", sats: 100, count: 46 },
        { id: 30, hand: "B8Z", sats: 100, count: 0 },
        { id: 31, hand: "C0", sats: 0, count: 521899 },
        { id: 32, hand: "C1", sats: 0, count: 3629952 },
        { id: 33, hand: "C2", sats: 0.5, count: 6415715 },
        { id: 34, hand: "C3", sats: 1, count: 6652148 },
        { id: 35, hand: "C4", sats: 2, count: 3411649 },
        { id: 36, hand: "C5", sats: 5, count: 1994094 },
        { id: 37, hand: "C6", sats: 10, count: 1289823 },
        { id: 38, hand: "C6X", sats: 10, count: 13104 },
        { id: 39, hand: "C6Z", sats: 10, count: 697 },
        // { id: 40, hand: "C7", sats: 0, count: 0 },
        // { id: 41, hand: "C7X", sats: 0, count: 0 },
        // { id: 42, hand: "C7Z", sats: 0, count: 0 },
        { id: 43, hand: "C8", sats: 100, count: 371139 },
        { id: 44, hand: "C8X", sats: 100, count: 5336 },
        { id: 45, hand: "C8Z", sats: 100, count: 201 },
    ];

    const total_counts = default_hands.reduce((sum, sats) => sum + sats.count, 0);
    default_hands = default_hands.map((hand) => ({
        ...hand,
        payout: hand.count * hand.sats,
        probability: (hand.count / total_counts).toFixed(8),
        payoutProbability: ((hand.count * hand.sats) / (total_counts * 10000)).toFixed(8)
    })
    )

    function saveLocalStorage() {
        localStorage.setItem(cache_key, JSON.stringify(hands));
    }

    if (localStorage.getItem(cache_key)) {
        hands = JSON.parse(localStorage.getItem(cache_key));
    } else {
        hands = JSON.parse(JSON.stringify(default_hands));
        saveLocalStorage();
    }



    function update_hands() {
        hands = hands.map((hand) => ({
            ...hand,
            payout: hand.count * hand.sats,
            probability: (hand.count / total_counts * 100).toFixed(8),
        }));
        total_payout = hands.reduce((sum, hand) => sum + hand.payout, 0);
        hands = hands.map((hand) => ({
            ...hand,
            payoutProbability: ((hand.payout) / (total_payout) * 100).toFixed(8)
        }));
    }


    function calculate_rtp() {
        const totalPayout = hands.reduce((sum, hand) => sum + (hand.payout), 0);
        return (totalPayout / total_counts).toFixed(8);
    }

    // for table sorting
    const ths_object = {
        'th-id': 1, // default to ascending order for 'Hand'
        'th-sats': 0,
        'th-count': 0,
        'th-probability': 0,
        'th-payout': 0,
        'th-payoutProbability': 0,
    };
    const ths = Object.keys(ths_object);

    for (let th of ths) {
        document.getElementById(th).addEventListener('click', () => {
            console.log(`Column ${th} clicked. Current sort order: ${ths_object[th]}`);

            ths.forEach((t) => {
                if (t !== th) {
                    ths_object[t] = 0; // reset other ths
                }
            });
            if (ths_object[th] !== 1) {
                ths_object[th] = 1; // ascending
                console.log(`Column ${th} set to ascending order.`);
            } else {
                ths_object[th] = -1; // descending
                console.log(`Column ${th} set to descending order.`);
            }
            calculate_and_render();
        });
    }

    function sort_rows(rows) {
        // get current ths
        const current_th = ths.find(th => ths_object[th] !== 0);
        if (!current_th) {
            return rows; // No sorting applied
        }
        const sortOrder = ths_object[current_th];
        if (sortOrder === 0) {
            return rows; // No sorting applied
        }
        return rows.sort((a, b) => {
            const aValue = parseFloat(a[current_th.replace('th-', '')]);
            const bValue = parseFloat(b[current_th.replace('th-', '')]);
            return sortOrder * (aValue - bValue);
        });
    }

    function update_html() {
        console.log('update_html');

        const tableBody = document.querySelector('tbody');
        tableBody.innerHTML = ''; // Clear existing rows

        for (hand of sort_rows(hands)) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${hand.hand}</td >
                <td>
                    <input type="number" id="${hand.id}" value="${hand.sats}" onclick="this.select()">
                </td>
                <td>${hand.count}</td>
                <td>${hand.probability}</td>
                <td>${hand.payout}</td>
                <td>${hand.payoutProbability}</td>
            `;
            tableBody.appendChild(row);
            const id = hand.id;
            const input = document.getElementById(hand.id);
            input.addEventListener('input', (event) => {
                const newSats = parseFloat(event.target.value);
                if (isNaN(newSats)) {
                    return
                }
                hands.filter(h => h.id === id)[0].sats = newSats;
                row.style.backgroundColor = 'red';
            });
            input.addEventListener('keypress', (event) => {
                if (event.key === 'Enter' || event.key === 13) {
                    calculate_and_render();
                    document.getElementById(id).focus();
                }
            });

        };

        const rtp = calculate_rtp();
        for (const el of document.querySelectorAll('.rtp')) {
            el.innerText = `RTP: ${rtp}`;
        };
    }

    function calculate_and_render() {
        update_hands();
        update_html();
        saveLocalStorage();
    }

    function copy_table() {
        let copy_text = '';
        for (hand of hands) {
            copy_text += `${hand.hand} => ${hand.sats}\n`;
        }
        navigator.clipboard.writeText(copy_text).then(() => {
            alert('Copied to clipboard');
        }).catch(err => {
            console.error('Failed to copy: ', err);
        });
    }

    function paste() {
        navigator.clipboard.readText().then(text => {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            lines.forEach(line => {
                console.log(line);

                const [hand, sats] = line.split('=>').map(part => part.trim());
                const handObj = hands.find(h => h.hand === hand);
                if (handObj) {
                    handObj.sats = parseFloat(sats);
                }
            });
            calculate_and_render();
        }).catch(err => {
            console.error('Failed to read clipboard contents: ', err);
        });
    }

    document.getElementById('paste').addEventListener('click', () => {
        paste();
    });

    document.getElementById('copy').addEventListener('click', () => {
        copy_table();
    });

    document.getElementById('reset').addEventListener('click', () => {
        localStorage.removeItem(cache_key);
        hands = JSON.parse(JSON.stringify(default_hands));
        calculate_and_render();
    });

    document.getElementById('update').addEventListener('click', () => {
        console.log('Update button clicked');
        calculate_and_render();
    });

    calculate_and_render();
</script>

</html>